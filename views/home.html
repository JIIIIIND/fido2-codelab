<!-- This is a static file -->
<!-- served from your routes in server.js -->

<!-- You might want to try something fancier: -->
<!-- html/nunjucks docs: https://mozilla.github.io/nunjucks/ -->
<!-- pug: https://pugjs.org/ -->
<!-- haml: http://haml.info/ -->
<!-- hbs(handlebars): http://handlebarsjs.com/ -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Welcome to Glitch!</title>
    <meta name="description" content="A cool thing made with Glitch">
    <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    <script src="/base64url-arraybuffer.js"></script>
  </head>
  <body>
    <header>
      <h1>
        WebAuthn codelab
      </h1>
    </header>

    <main>
      <h2>
        Welcome, {{username}}!
      </h2>
      <h3>
        Your registered credentials:
      </h3>
      <section id="list">
      </section>
      <p>
        <a href="/">Try reauth</a>
      </p>
      <p>
        <a href="/auth/signout">Sign out</a>
      </p>
    </main>
    <script type="module">
      import { _fetch, registerCredential, unregisterCredential } from '/client.js';
      import { html, render } from 'https://unpkg.com/lit-html@1.0.0/lit-html.js?module';
      import { repeat } from 'https://unpkg.com/lit-html@1.0.0/directives/repeat.js?module';

      const makeCredential = async () => {
        registerCredential({
          attestation: 'none',
          authenticatorSelection: {
            authenticatorAttachment: 'platform',
            userVerification: 'required'
          }
        })
        .then(user => {
          if (user) {
            getCredential();
          } else {
            console.info('Registering credential silently failed.');
          }
        })
        .catch(e => {
          if (e) {
            alert(e);
          } else {
            alert('Unkown error.');
          }
        });
      };

      const getCredential = () => {
        _fetch('/auth/getKey').then(res => {
          const list = document.querySelector('#list');
          const li = html`<ul>
            ${repeat(res.credentials, cred => cred.credId, (cred, index) => html`<li>${cred.credId}
              <button id="${cred.credId}" @click=${removeCredential}>Remove</button>
            </li>`)}
            </ul>
            <button @click=${makeCredential}>Register a new credential</button>`
          render(li, list);
        });
      };

      const removeCredential = e => {
        unregisterCredential(e.target.id)
        .then(() => {
          getCredential();
        })
        .catch(e => {
          if (e) {
            alert(e.error);
          } else {
            alert('Unkown error.');
          }
        });
      };
      getCredential();
    </script>
  </body>
</html>
