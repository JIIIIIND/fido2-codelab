<!-- This is a static file -->
<!-- served from your routes in server.js -->

<!-- You might want to try something fancier: -->
<!-- html/nunjucks docs: https://mozilla.github.io/nunjucks/ -->
<!-- pug: https://pugjs.org/ -->
<!-- haml: http://haml.info/ -->
<!-- hbs(handlebars): http://handlebarsjs.com/ -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Welcome to Glitch!</title>
    <meta name="description" content="A cool thing made with Glitch">
    <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
    <script src="/base64url-arraybuffer.js"></script>
  </head>
  <body class="mdc-typography">
    <header class="mdc-top-app-bar" style="top:0px">
      <h1 class="mdc-top-app-bar__title">
        WebAuthn codelab
      </h1>
    </header>

    <main class="content mdc-top-app-bar--fixed-adjust">
      <h2>
        Welcome, {{username}}!
      </h2>
      <h3 class="mdc-typography mdc-typography--headline6">
        Your registered credentials:
      </h3>
      <section>
        <div id="list">
          
        </div>
        <button id="register" class="mdc-fab mdc-ripple-upgraded">
          <i class="mdc-fab__icon material-icons">+</i>
        </button>
      </section>
      <p>
        <a href="/">Try reauth</a>
      </p>
      <p>
        <a href="/auth/signout">Sign out</a>
      </p>
    </main>
    <script type="module">
      import { _fetch, registerCredential, unregisterCredential } from '/client.js';
      import { html, render } from 'https://unpkg.com/lit-html@1.0.0/lit-html.js?module';
      import { repeat } from 'https://unpkg.com/lit-html@1.0.0/directives/repeat.js?module';

      const register = document.querySelector('#register');
      register.addEventListener('click', e => {
        registerCredential({
          attestation: 'none',
          authenticatorSelection: {
            authenticatorAttachment: 'platform',
            userVerification: 'required'
          }
        })
        .then(user => {
          if (user) {
            getCredentials();
          } else {
            console.info('Registering credential silently failed.');
          }
        })
        .catch(e => alert(e));
      });

      const removeCredential = async e => {
        try {
          const res = await _fetch(`/auth/removeKey?credId=${encodeURIComponent(e.target.id)}`)
          getCredentials();
        } catch (e) {
          alert(e); 
        }
      };

      const getCredentials = async () => {
        const res = await _fetch('/auth/getKeys');
        const list = document.querySelector('#list');
        if (res.credentials.length === 0) {
          list.innerHTML = '<div>No credentials found.</div>';
          return;
        }
        const creds = html`${repeat(res.credentials, cred => cred.credId,(cred, index) =>
          html`<div class="mdc-card credential">
            <span class="mdc-typography mdc-typography--body2">${cred.credId}</span>
            <pre class="public-key">${cred.publicKey}</pre>
            <div class="mdc-card__actions">
              <button id="${cred.credId}" class="mdc-button mdc-button--raised" @click="${removeCredential}">Remove</button>
            </div>
          </div>`)}`;
        render(creds, list);
      };

      getCredentials();
    </script>
  </body>
</html>
